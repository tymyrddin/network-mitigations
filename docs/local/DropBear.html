<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DropBear SSH public key authentication (OpenWRT) &mdash; Network mitigations</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Use the strongest encryption protocol available" href="Encryption.html" />
    <link rel="prev" title="Disable WPS" href="Disable-WPS.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Network mitigations
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Local</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Home network</a></li>
<li class="toctree-l1"><a class="reference internal" href="Add-a-second-NAT-router.html">Add a second NAT router</a></li>
<li class="toctree-l1"><a class="reference internal" href="Change-router-defaults.html">Change router defaults</a></li>
<li class="toctree-l1"><a class="reference internal" href="Disable-WPS.html">Disable WPS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DropBear SSH public key authentication (OpenWRT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Encryption.html">Use the strongest encryption protocol available</a></li>
<li class="toctree-l1"><a class="reference internal" href="Flash-router-with-other-firmware.html">Flash router with other firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="Nethogs.html">Nethogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Off.html">Turn it off</a></li>
<li class="toctree-l1"><a class="reference internal" href="Off.html#disable-services-when-not-needed">Disable services when not needed</a></li>
<li class="toctree-l1"><a class="reference internal" href="Port-forwarding.html">Port forwarding</a></li>
<li class="toctree-l1"><a class="reference internal" href="Portknocking.html">Portknocking</a></li>
<li class="toctree-l1"><a class="reference internal" href="Protect-router-management.html">Protect router management</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reduce-wireless-signal-strength.html">Reduce wireless signal strength</a></li>
<li class="toctree-l1"><a class="reference internal" href="Services-audit.html">Services audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="Unauthorised-devices.html">Unauthorised devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="Upgrade-router-firmware.html">Upgrade router firmware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Intranet</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intranet/README.html">Intranet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intranet/ARP-spoofing.html">ARP spoofing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intranet/DNS-cache-poisoning.html">DNS cache poisoning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intranet/LAN-segmentation.html">LAN segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intranet/NFTables.html">NFTables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intranet/Snort-box.html">Snort box</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Internet</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../internet/README.html">Internet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internet/BGP-hijacking.html">BGP hijacking mitigations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internet/Certificate-validation.html">Certificate validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">All mitigations</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://tymyrddin.github.io/mitigations/">Overview</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Network mitigations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>DropBear SSH public key authentication (OpenWRT)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/local/DropBear.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dropbear-ssh-public-key-authentication-openwrt">
<h1>DropBear SSH public key authentication (OpenWRT)<a class="headerlink" href="#dropbear-ssh-public-key-authentication-openwrt" title="Permalink to this heading"></a></h1>
<p>If you do not have a public key yet, create one.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ssh-keygen -t dsa    
</pre></div>
</div>
<p><img alt="Create key" src="../../_images/create-key.png" /></p>
<p>Followed by a fingerprint and random art image of the key.</p>
<p>Copy the public key with <code class="docutils literal notranslate"><span class="pre">scp</span></code> to OpenWrt:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ scp ~/.ssh/id_dsa.pub root@192.168.1.1:/tmp    
</pre></div>
</div>
<p><img alt="SCP" src="../../_images/scp.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">ssh</span></code> to the router (requires a password, as the key has not been added to authorized_keys yet).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ssh root@192.168.1.1    
</pre></div>
</div>
<p><img alt="Password" src="../../_images/ssh-still-password-asked.png" /></p>
<p>Add the key to <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code>. If not exists, it will be created. Adjust its permissions.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd /etc/dropbear
# cat /tmp/id_*.pub &gt;&gt; authorized_keys
# chmod 0600 authorized_keys    
</pre></div>
</div>
<p><img alt="Add to authorised keys" src="../../_images/add-to-authorized-keys.png" /></p>
<p>Now ssh works from a local machine to the router, and no password is sent in the clear or encrypted, instead you’ll be asked for the passphrase you entered when you created the key in the first step. You can repeat this from each machine that you wish to be able to access the router, and add the keys as above.</p>
<section id="running-ssh-on-another-port">
<h2>Running SSH on another port<a class="headerlink" href="#running-ssh-on-another-port" title="Permalink to this heading"></a></h2>
<p><img alt="SSH access" src="../../_images/ssh-access.png" /></p>
<p>That of course changes how you <code class="docutils literal notranslate"><span class="pre">ssh</span></code> to the router:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ssh root@192.168.1.1 -p 22222    
</pre></div>
</div>
</section>
<section id="whitelisting-ip-s">
<h2>Whitelisting IP’s<a class="headerlink" href="#whitelisting-ip-s" title="Permalink to this heading"></a></h2>
<p>Allow SSH only from trusted (whitelisted) IP’s, and drop any other request to <code class="docutils literal notranslate"><span class="pre">port</span> <span class="pre">22</span></code>. If doing that from a Local Area Network (LAN) you will need to set a static DHCP address first. dnsmasq is default running on OpenWrt; it allocates IP addresses in the range of 192.168.1.100 to .250 on the internal interface to connected hosts. Pick an IP address outside these, like <code class="docutils literal notranslate"><span class="pre">192.168.1.251</span></code></p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">/etc/lists/whitelist.conf</span></code> with in it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>192.168.1.251                        ## A trusted IP
192.168.1.252                        ## Another trusted IP    
</pre></div>
</div>
<p>And open up <code class="docutils literal notranslate"><span class="pre">/etc/firewall.user</span></code> and add:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>WHITELIST=$(sed &#39;s/#.*//&#39; /etc/lists/whitelist.conf)

for IP in ${WHITELIST}; do
    iptables -t nat -A prerouting_rule -i $WAN -s $IP -p tcp --dport 22 -j ACCEPT
    iptables        -A input_rule      -i $WAN -s $IP -p tcp --dport 22 -j ACCEPT    
</pre></div>
</div>
<p>Done.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Disable-WPS.html" class="btn btn-neutral float-left" title="Disable WPS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Encryption.html" class="btn btn-neutral float-right" title="Use the strongest encryption protocol available" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
        <a href="https://unseen-uni.netlify.app/">Unseen University</a>, 2022

  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>